{% extends base_main_content_template %}
{% load static %}
{% load crispy_forms_tags %}

{% block main_content %}
    <div class="row text-center">
        <div class="horizontal-center">
            <h2>{{ title }}</h3>
        </div>        
    </div>

    <form method="post" id="recordSelectForm">
        {% csrf_token %}
        <!-- Hidden field to store the selected record's ID -->
        <input type="hidden" name="record" id="selectedRecord">
        <input type="hidden" name="model_name" value="{{ form.model_name.value }}">

        <!-- Table to display records -->
        <div id="recordsTable"></div>

    </form>

    <!-- Download Button Container -->
        {% if records %}
        <div class="container mt-3" id="download-csv-container" style="display: none;">
            <button id="download-csv" class="btn btn-success">Download CSV</button>
        </div>
        {% endif %}
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var recordsData = {{ records|safe }}; // Assuming records is a JSON serialized array
        var table = new Tabulator("#recordsTable", {
            data: recordsData,
            layout: "fitColumns",
            columns: generateColumns(recordsData),
        });

        // Bind rowClick event using the Tabulator recommended way
        table.on("rowClick", function(e, row){
            // Get the record ID as before
            var recordId = row.getData().id;
            document.getElementById('selectedRecord').value = recordId;
            // Submit the form
            document.getElementById('recordSelectForm').submit();
        });


        function generateColumns(dataArray) {
            if (!dataArray.length) return [];
            var keys = Object.keys(dataArray[0]);
            return keys.map(function(key) {
                return {
                    title: key.charAt(0).toUpperCase() + key.slice(1),
                    field: key,
                    headerFilter: "input",
                    sorter: true,
                };
            });
        }

        // Make the download button visible
        document.getElementById("download-csv-container").style.display = 'block';

        // Flag to check if the event listener has been attached
        var isDownloadListenerAttached = false;

        // Attach event listener to the download button if not already attached
        if (!isDownloadListenerAttached) {
            document.getElementById("download-csv").addEventListener("click", function() {
                table.download("csv", "data.csv");
            });

            // Update the flag
            isDownloadListenerAttached = true;
        }

    });
</script>
{% endblock %}
