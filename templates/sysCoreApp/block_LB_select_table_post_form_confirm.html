{% extends base_main_content_template %}
{% load static %}
{% load crispy_forms_tags %}

{% block main_content %}
    <div class="row text-center">
        <div class="horizontal-center">
            <h2>{{ title }}</h3>
        </div>        
    </div>

    <form method="post" id="recordSelectForm">
        {% csrf_token %}
        <!-- Hidden field to store the selected record's ID -->
        <input type="hidden" name="record" id="selectedRecord">
        <input type="hidden" name="model_name" value="{{ form.model_name.value }}">

        <!-- Table to display records -->
        <div id="recordsTable"></div>

    </form>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var recordsData = {{ records|safe }}; // Assuming records is a JSON serialized array
        var table = new Tabulator("#recordsTable", {
            data: recordsData,
            layout: "fitColumns",
            columns: generateColumns(recordsData),
        });

        // Bind rowClick event using the Tabulator recommended way
        table.on("rowClick", function(e, row){
            // Get the record ID as before
            var recordId = row.getData().id;
            document.getElementById('selectedRecord').value = recordId;

            // Confirmation dialog
            if (confirm("Are you sure you want to delete this record?")) {
                // If the user confirmed, submit the form
                document.getElementById('recordSelectForm').submit();
            }
            // If the user did not confirm, do nothing (the form will not be submitted)
        });


        function generateColumns(dataArray) {
            if (!dataArray.length) return [];
            var keys = Object.keys(dataArray[0]);
            return keys.map(function(key) {
                return {
                    title: key.charAt(0).toUpperCase() + key.slice(1),
                    field: key,
                    headerFilter: "input",
                    sorter: true,
                };
            });
        }

    });
</script>
{% endblock %}
