{% extends base_main_content_template %}
{% load static %}

{% block main_content %}
<!-- First row (full width) -->
<div class="row">
    <div class="horizontal-center">
        <h2>{{ title }}</h2>
    </div>        
</div>

<!-- First Dropdown with Submit Button -->
<div class="row">
    <form method="post" id="first-dropdown-form">
        {% csrf_token %}
        {{ first_dropdown_form.as_p }}
        <button type="submit" id="first-dropdown-submit">Load Second Dropdown</button>         
    </form>
</div>

<!-- Second Dropdown with Submit Button (Initially hidden) -->
<div class="row" style="display: none;" id="second-dropdown-container">
    <form id="second-dropdown-form">
        <select id="second-dropdown" multiple>
            <!-- Options will be populated here by AJAX -->
        </select>
        <button type="submit" id="second-dropdown-submit">Show Data</button>
    </form>
</div>

<!-- Data Table Container (Initially hidden) -->
<div class="row" style="display: none;" id="data-table-container">
    <table id="data-table" class="table dataTable">
        <!-- Table data will be populated here by AJAX -->
    </table>
</div>

{% if data %}
<a href="?download=true" class="btn btn-primary">Download CSV</a>
{% endif %}

{% if test_str %}
<div class="row">
    <h3>Testing:</h3>
    <p>{{ test_str|safe }}</p>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const firstDropdownForm = document.getElementById('first-dropdown-form');
        const secondDropdownForm = document.getElementById('second-dropdown-form');

        firstDropdownForm.addEventListener('submit', function(event) {
            event.preventDefault();

            // Get all selected options from the first dropdown
            const firstDropdown = firstDropdownForm.querySelector('select[name="categories"]');
            const selectedValuesFromFirstDropdown = Array.from(firstDropdown.selectedOptions).map(option => option.value);

            fetch('/{{end_point}}/{{module_name}}/update_second_dropdown/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ categories: selectedValuesFromFirstDropdown })
            })
            .then(response => response.json())
            .then(data => {
                console.log(data); // For debugging
                const secondDropdownContainer = document.getElementById('second-dropdown-container');
                const secondDropdown = document.getElementById('second-dropdown');
                secondDropdown.innerHTML = data.options.map(option => `<option value="${option.value}">${option.label}</option>`).join('');
                secondDropdownContainer.style.display = 'block';
            });

            return false;
        });

        secondDropdownForm.addEventListener('submit', function(event) {
            event.preventDefault();

            const secondDropdown = document.getElementById('second-dropdown');
            const selectedValuesFromSecondDropdown = Array.from(secondDropdown.selectedOptions).map(option => option.value);

            fetch('/{{end_point}}/{{module_name}}/fetch_table_data/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ categories: selectedValuesFromSecondDropdown })
            })
            .then(response => response.json())
            .then(responseData => {
                console.log(responseData); // For debugging
                const dataTableContainer = document.getElementById('data-table-container');
                const dataTable = document.getElementById('data-table');

                if (responseData && responseData.data && responseData.data.length > 0) {
                    const data = responseData.data;

                    // Create table headers based on keys of the first item in the data array
                    let headers = Object.keys(data[0]);
                    let thead = '<thead><tr>';
                    headers.forEach(header => {
                        thead += `<th>${header}</th>`;
                    });
                    thead += '</tr></thead>';

                    // Create table rows
                    let tbody = '<tbody>';
                    data.forEach(row => {
                        tbody += '<tr>';
                        headers.forEach(header => {
                            tbody += `<td>${row[header]}</td>`;
                        });
                        tbody += '</tr>';
                    });
                    tbody += '</tbody>';

                    // Combine headers and rows and update the table
                    dataTable.innerHTML = thead + tbody;

                    dataTableContainer.style.display = 'block';
                } else {
                    // Handle case where no data is returned or data structure is not as expected
                    dataTable.innerHTML = '<tr><td colspan="100%">No data available</td></tr>';
                    dataTableContainer.style.display = 'block';
                }
            });
        });
    });
</script>
{% endblock %}
